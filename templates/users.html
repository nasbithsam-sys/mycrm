{% extends "base.html" %}
{% block title %}User Management - AccBoost CRM{% endblock %}

{% block content %}
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h1 class="page-title">User Management</h1>
      <div class="text-muted mt-1">Manage system users and their permissions (Admin Only)</div>
    </div>
    <div class="col-auto">
      <div class="btn-list">
        <!-- Add User -->
        <a href="{{ url_for('register') }}" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user-plus" width="16" height="16"
               viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
               stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
            <path d="M16 19h6" />
            <path d="M19 16v6" />
            <path d="M6 21v-2a4 4 0 0 1 4 -4h4" />
          </svg>
          Add User
        </a>

        <!-- Export -->
        <button class="btn btn-outline-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="16" height="16"
               viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
               stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
            <path d="M7 11l5 5l5 -5" />
            <path d="M12 4v12" />
          </svg>
          Export
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”¹ User Statistics -->
<div class="row row-deck mb-4">

  <!-- Total Users -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="avatar bg-primary text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                   viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                   stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M9 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
              </svg>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">Total Users</div>
            <div class="h2 mt-2 mb-0 text-primary">{{ users|length }}</div>
            <div class="text-muted small">All system users</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admins -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="avatar bg-success text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                   viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
                   fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3" />
              </svg>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">Administrators</div>
            <div class="h2 mt-2 mb-0 text-success">
              {{ users|selectattr('role', 'equalto', 'admin')|list|length }}
            </div>
            <div class="text-muted small">Full system access</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Processors -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="avatar bg-info text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                   viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                   stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M12 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                <path d="M6 21v-2a4 4 0 0 1 4 -4h8" />
              </svg>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">Processors</div>
            <div class="h2 mt-2 mb-0 text-info">
              {{ users|selectattr('role', 'equalto', 'processor')|list|length }}
            </div>
            <div class="text-muted small">Limited lead access</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Standard Users -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="avatar bg-warning text-white">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                   viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                   stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M12 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
              </svg>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">Standard Users</div>
            <div class="h2 mt-2 mb-0 text-warning">
              {{ users|selectattr('role', 'equalto', 'user')|list|length }}
            </div>
            <div class="text-muted small">Lead management only</div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ðŸ”¹ Users Table -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">All Users</h3>
  </div>

  <div class="card-body">
    {% if users %}
    <div class="table-responsive">
      <table class="table table-vcenter table-hover align-middle">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Created</th>
            <th>Leads</th>
            <th>Status</th>
            <th class="w-1">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <span class="avatar avatar-sm bg-primary-lt me-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="20" height="20"
                       viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
                       fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M12 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                  </svg>
                </span>
                <div>
                  <div class="fw-bold">{{ user.username }}</div>
                  <div class="text-muted small">ID: {{ user.id }}</div>
                  {% if user.otp_secret and current_user.role == 'admin' %}
                  <div class="text-muted small mt-1">
                    <span class="badge bg-light text-dark">
                      ðŸ”‘ OTP Secret: <code>{{ user.otp_secret }}</code>
                    </span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </td>

            <td>
              {% if user.role == 'admin' %}
              <span class="badge bg-success-lt">Admin</span>
              {% elif user.role == 'processor' %}
              <span class="badge bg-info-lt">Processor</span>
              {% else %}
              <span class="badge bg-secondary-lt">User</span>
              {% endif %}
            </td>

            <td class="text-muted small">
              {{ user.created_at.strftime('%b %d, %Y') if user.created_at else 'N/A' }}
            </td>

            <td><span class="badge bg-primary">{{ user.leads|length if user.leads else 0 }}</span></td>

            <td>
              {% if current_user.id == user.id %}
              <span class="badge bg-info-lt">Current</span>
              {% else %}
              <span class="badge bg-success-lt">Active</span>
              {% endif %}
            </td>

            <td>
              <div class="dropdown">
                <button class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                  Actions
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item text-muted" href="#" onclick="alert('Edit feature coming soon!'); return false;">Edit</a>
                  <a class="dropdown-item text-muted" href="#" onclick="alert('Role change feature coming soon!'); return false;">Change Role</a>
                  <div class="dropdown-divider"></div>
                  {% if current_user.id != user.id %}
                  <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST"
                        onsubmit="return confirm('Are you sure you want to delete {{ user.username }}?');">
                    <button type="submit" class="dropdown-item text-danger">Delete</button>
                  </form>
                  {% else %}
                  <span class="dropdown-item text-muted">Cannot Delete Self</span>
                  {% endif %}
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty text-center py-5">
      <p class="empty-title">No users found</p>
      <p class="empty-subtitle text-muted">Users will appear here once they register.</p>
      <div class="empty-action">
        <a href="{{ url_for('register') }}" class="btn btn-primary">Create First User</a>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
