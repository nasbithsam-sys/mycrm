{% extends "base.html" %}
{% block title %}Analytics - AccBoost CRM{% endblock %}

{% block content %}
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h1 class="page-title">ðŸ“Š Advanced Analytics</h1>
      <div class="text-muted mt-1">Comprehensive insights and performance metrics</div>
    </div>
    <div class="col-auto">
      <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="16" height="16"
               viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
               stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
            <path d="M7 11l5 5l5 -5" />
            <path d="M12 4v12" />
          </svg>
          Export Data
        </button>
        <div class="dropdown-menu dropdown-menu-end shadow">
          <a class="dropdown-item" href="{{ url_for('export_leads') }}">
            <i class="ti ti-file-spreadsheet me-2"></i> Export Active Leads (CSV)
          </a>
          <a class="dropdown-item" href="{{ url_for('export_closed_leads') }}">
            <i class="ti ti-archive me-2"></i> Export Closed Leads (CSV)
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Summary Cards -->
<div class="row row-deck mb-4">
  <!-- Today -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-primary text-white avatar">
              <i class="ti ti-calendar-event"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Today's Leads</div>
            <div class="h2 mt-2 mb-0 text-primary">{{ today_leads }}</div>
            <div class="text-success small d-flex align-items-center">
              <i class="ti ti-trending-up me-1"></i> Active today
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Weekly -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-success text-white avatar">
              <i class="ti ti-calendar-week"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Weekly Total</div>
            <div class="h2 mt-2 mb-0 text-success">{{ week_leads|sum if week_leads else 0 }}</div>
            <div class="text-muted small">Last 4 weeks</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Monthly -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-warning text-white avatar">
              <i class="ti ti-calendar-month"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Monthly Total</div>
            <div class="h2 mt-2 mb-0 text-warning">{{ month_leads|sum if month_leads else 0 }}</div>
            <div class="text-warning small">Last 6 months</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmed -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-info text-white avatar">
              <i class="ti ti-check"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Confirmed Leads</div>
            <div class="h3 mt-2 mb-0 text-info">
              {% if confirmed_dept_stats and confirmed_dept_stats|length > 0 %}
                {{ confirmed_dept_stats|sum(attribute=1) }}
              {% else %}0{% endif %}
            </div>
            <div class="text-info small">Successfully closed</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tabs for charts -->
<div class="card shadow-sm">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
      <li class="nav-item"><a href="#weekly" class="nav-link active" data-bs-toggle="tab">Weekly</a></li>
      <li class="nav-item"><a href="#monthly" class="nav-link" data-bs-toggle="tab">Monthly</a></li>
      <li class="nav-item"><a href="#dept" class="nav-link" data-bs-toggle="tab">Departments</a></li>
      <li class="nav-item"><a href="#status" class="nav-link" data-bs-toggle="tab">Status</a></li>
    </ul>
  </div>

  <div class="card-body">
    <div class="tab-content">
      <div class="tab-pane active show" id="weekly">
        <h3 class="card-title">Weekly Performance</h3>
        <div style="height:400px;"><canvas id="weeklyChart"></canvas></div>
      </div>

      <div class="tab-pane" id="monthly">
        <h3 class="card-title">Monthly Growth</h3>
        <div style="height:400px;"><canvas id="monthlyChart"></canvas></div>
      </div>

      <div class="tab-pane" id="dept">
        <div class="row">
          <div class="col-lg-8">
            <h3 class="card-title">Department Overview</h3>
            <div style="height:400px;"><canvas id="deptChart"></canvas></div>
          </div>
          <div class="col-lg-4">
            <h4 class="card-title">Department Stats</h4>
            <div class="list-group list-group-flush">
              {% for dept, count in dept_stats %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>{{ dept }}</span>
                  <span class="badge bg-primary">{{ count }}</span>
                </div>
                <div class="progress progress-sm mt-2">
                  <div class="progress-bar" style="width: {{ (count / (dept_stats|sum(attribute='1') or 1)) * 100 }}%"></div>
                </div>
                <small class="text-muted">{{ "%.1f"|format((count / (dept_stats|sum(attribute='1') or 1)) * 100) }}%</small>
              </div>
              {% endfor %}
            </div>

            <h4 class="card-title mt-4">Confirmed Leads</h4>
            <div class="list-group list-group-flush">
              {% for dept, count in confirmed_dept_stats %}
              <div class="list-group-item d-flex justify-content-between">
                <span>{{ dept }}</span>
                <span class="badge bg-success">{{ count }}</span>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane" id="status">
        <div class="row">
          <div class="col-lg-8">
            <h3 class="card-title">Lead Status Distribution</h3>
            <div style="height:400px;"><canvas id="statusChart"></canvas></div>
          </div>
          <div class="col-lg-4">
            <h4 class="card-title">Status Breakdown</h4>
            <div class="list-group list-group-flush">
              {% for status, count in status_stats %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>{{ status }}</span>
                  <span class="badge 
                    {% if status == 'New Lead' %}bg-blue
                    {% elif status == 'Issue in Lead' %}bg-red
                    {% elif status == 'Pending Outreach' %}bg-orange
                    {% elif status == 'Texted / Call Done' %}bg-yellow
                    {% elif status == 'In Progress' %}bg-purple
                    {% elif status == 'Done' %}bg-green
                    {% else %}bg-secondary{% endif %}">
                    {{ count }}
                  </span>
                </div>
                <div class="progress progress-sm mt-2">
                  <div class="progress-bar"
                       style="width: {{ (count / (status_stats|sum(attribute='1') or 1)) * 100 }}%">
                  </div>
                </div>
                <small class="text-muted">{{ "%.1f"|format((count / (status_stats|sum(attribute='1') or 1)) * 100) }}%</small>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const weeklyChart = new Chart(document.getElementById('weeklyChart'), {
    type: 'bar',
    data: {
      labels: {{ week_labels|tojson if week_labels else ['Week 1','Week 2','Week 3','Week 4'] }},
      datasets: [{
        data: {{ week_leads|tojson if week_leads else [0,0,0,0] }},
        backgroundColor: 'rgba(39, 174, 96, 0.8)',
        borderRadius: 6
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  const monthlyChart = new Chart(document.getElementById('monthlyChart'), {
    type: 'line',
    data: {
      labels: {{ month_labels|tojson if month_labels else ['Jan','Feb','Mar','Apr','May','Jun'] }},
      datasets: [{
        data: {{ month_leads|tojson if month_leads else [0,0,0,0,0,0] }},
        borderColor: '#f1c40f', backgroundColor: 'rgba(241,196,15,0.15)', tension: 0.4, fill: true
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  const deptChart = new Chart(document.getElementById('deptChart'), {
    type: 'doughnut',
    data: {
      labels: {{ dept_stats|map(attribute='0')|list|tojson if dept_stats else [] }},
      datasets: [{
        data: {{ dept_stats|map(attribute='1')|list|tojson if dept_stats else [] }},
        backgroundColor: ['#206bc4','#4299e1','#667eea','#f093fb','#e53e3e','#f59e0b','#10b981']
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  const statusChart = new Chart(document.getElementById('statusChart'), {
    type: 'pie',
    data: {
      labels: {{ status_stats|map(attribute='0')|list|tojson if status_stats else [] }},
      datasets: [{
        data: {{ status_stats|map(attribute='1')|list|tojson if status_stats else [] }},
        backgroundColor: ['#206bc4','#e53e3e','#f59f00','#8b5cf6','#10b981','#6b7280']
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
});
</script>

<style>
.bg-blue { background-color: #206bc4 !important; color: #fff; }
.bg-red { background-color: #e53e3e !important; color: #fff; }
.bg-orange { background-color: #f59f00 !important; color: #fff; }
.bg-yellow { background-color: #fbbf24 !important; color: #000; }
.bg-purple { background-color: #8b5cf6 !important; color: #fff; }
.bg-green { background-color: #10b981 !important; color: #fff; }
</style>
{% endblock %}
{% endblock %}
