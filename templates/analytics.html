{% extends "base.html" %}
{% block title %}Analytics - AccBoost CRM{% endblock %}

{% block content %}
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h1 class="page-title">ðŸ“Š Advanced Analytics</h1>
      <div class="text-muted mt-1">Comprehensive insights and performance metrics</div>
    </div>
    <div class="col-auto">
      <div class="dropdown">
        <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="16" height="16"
               viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
               stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
            <path d="M7 11l5 5l5 -5" />
            <path d="M12 4v12" />
          </svg>
          Export Data
        </button>
        <div class="dropdown-menu dropdown-menu-end shadow">
          <a class="dropdown-item" href="{{ url_for('export_leads') }}">
            <i class="ti ti-file-spreadsheet me-2"></i> Export Active Leads (CSV)
          </a>
          <a class="dropdown-item" href="{{ url_for('export_closed_leads') }}">
            <i class="ti ti-archive me-2"></i> Export Closed Leads (CSV/XLSX/PDF)
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form class="row g-3" method="get" action="{{ url_for('analytics') }}">
      <div class="col-md-3">
        <label class="form-label">Start date</label>
        <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">End date</label>
        <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Granularity</label>
        <select class="form-select" name="granularity">
          <option value="day"   {{ 'selected' if granularity=='day' }}>Daily</option>
          <option value="week"  {{ 'selected' if granularity=='week' }}>Weekly</option>
          <option value="month" {{ 'selected' if granularity=='month' }}>Monthly</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Department</label>
        <select class="form-select" name="department">
          <option value="all" {{ 'selected' if selected_department=='all' }}>All</option>
          {% for d in departments %}
            <option value="{{ d }}" {{ 'selected' if selected_department==d }}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary"><i class="ti ti-filter"></i> Apply</button>

        <!-- Quick presets (NO timedelta in Jinja) -->
        <a class="btn btn-outline-secondary"
           href="{{ url_for('analytics',
                            start_date=today_str,
                            end_date=today_str,
                            granularity='day',
                            department=selected_department) }}">
          Today
        </a>

        <a class="btn btn-outline-secondary"
           href="{{ url_for('analytics',
                            start_date=last7_start_str,
                            end_date=today_str,
                            granularity='day',
                            department=selected_department) }}">
          Last 7 days
        </a>

        <a class="btn btn-outline-secondary"
           href="{{ url_for('analytics',
                            start_date=month_start_str,
                            end_date=today_str,
                            granularity='day',
                            department=selected_department) }}">
          This Month
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Summary Cards -->
<div class="row row-deck mb-4">
  <!-- Today -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-primary text-white avatar">
              <i class="ti ti-calendar-event"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Today's Leads</div>
            <div class="h2 mt-2 mb-0 text-primary">{{ today_leads }}</div>
            <div class="text-success small d-flex align-items-center">
              <i class="ti ti-trending-up me-1"></i> {{ now.strftime('%Y-%m-%d') }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- In Range -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-success text-white avatar">
              <i class="ti ti-chart-bar"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Leads in Range</div>
            <div class="h2 mt-2 mb-0 text-success">{{ total_in_range }}</div>
            <div class="text-muted small">{{ start_date }} â†’ {{ end_date }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vs Prev Period + Avg/day -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-warning text-white avatar">
              <i class="ti ti-arrows-double-ne-sw"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Vs Prev Period</div>
            <div class="h2 mt-2 mb-0 text-warning">
              {% if total_delta_pct is not none %}{{ total_delta_pct }}%{% else %}â€”{% endif %}
            </div>
            <div class="text-muted small">Avg/day: {{ avg_per_day }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Avg Close Time -->
  <div class="col-sm-6 col-lg-3">
    <div class="card card-sm shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-info text-white avatar">
              <i class="ti ti-clock-hour-4"></i>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium text-uppercase small text-muted">Avg Close Time</div>
            <div class="h2 mt-2 mb-0 text-info">
              {% if avg_cycle_hours is not none %}{{ avg_cycle_hours }}h{% else %}â€”{% endif %}
            </div>
            <div class="text-muted small">For closed leads in range</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="card shadow-sm">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
      <li class="nav-item"><a href="#timeseries" class="nav-link active" data-bs-toggle="tab">Time Series</a></li>
      <li class="nav-item"><a href="#dept" class="nav-link" data-bs-toggle="tab">Departments</a></li>
      <li class="nav-item"><a href="#users" class="nav-link" data-bs-toggle="tab">Users</a></li>
      <li class="nav-item"><a href="#status" class="nav-link" data-bs-toggle="tab">Funnel / Status</a></li>
      <li class="nav-item"><a href="#heatmap" class="nav-link" data-bs-toggle="tab">Heatmap</a></li>
      <li class="nav-item"><a href="#quality" class="nav-link" data-bs-toggle="tab">Data Quality</a></li>
      <li class="nav-item"><a href="#pivot" class="nav-link" data-bs-toggle="tab">Users Ã— Departments</a></li>
    </ul>
  </div>

  <div class="card-body">
    <div class="tab-content">
      <!-- Time Series -->
      <div class="tab-pane active show" id="timeseries">
        <h3 class="card-title">Leads Over Time</h3>
        <div style="height:400px;"><canvas id="tsChart"></canvas></div>
      </div>

      <!-- Departments -->
      <div class="tab-pane" id="dept">
        <div class="row">
          <div class="col-lg-8">
            <h3 class="card-title">Department Overview (In Range)</h3>
            <div style="height:400px;"><canvas id="deptChart"></canvas></div>
          </div>
          <div class="col-lg-4">
            <h4 class="card-title">Department Stats</h4>
            <div class="list-group list-group-flush">
              {% set dept_total = (dept_counts|sum) if dept_counts else 0 %}
              {% for i in range(dept_labels|length) %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>{{ dept_labels[i] }}</span>
                  <span class="badge bg-primary">{{ dept_counts[i] }}</span>
                </div>
                <div class="progress progress-sm mt-2">
                  <div class="progress-bar" style="width: {{ (dept_counts[i] / (dept_total or 1)) * 100 }}%"></div>
                </div>
                <small class="text-muted">{{ "%.1f"|format((dept_counts[i] / (dept_total or 1)) * 100) }}%</small>
              </div>
              {% endfor %}
            </div>

            <h4 class="card-title mt-4">Confirmed Leads (All-Time / Current)</h4>
            <div class="list-group list-group-flush">
              {% if confirmed_dept_stats %}
                {% for dept, count in confirmed_dept_stats %}
                  <div class="list-group-item d-flex justify-content-between">
                    <span>{{ dept }}</span>
                    <span class="badge bg-success">{{ count }}</span>
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted small">No confirmed data available.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Users -->
      <div class="tab-pane" id="users">
        <h3 class="card-title">Leads by User (Added By)</h3>
        <div style="height:400px;"><canvas id="userChart"></canvas></div>
      </div>

      <!-- Funnel / Status -->
      <div class="tab-pane" id="status">
        <div class="row">
          <div class="col-lg-8">
            <h3 class="card-title">Lead Status Distribution (Created in Range)</h3>
            <div style="height:400px;"><canvas id="funnelChart"></canvas></div>
          </div>
          <div class="col-lg-4">
            <h4 class="card-title">Status Breakdown</h4>
            <div class="list-group list-group-flush">
              {% set st_total = (funnel_counts|sum) if funnel_counts else 0 %}
              {% for i in range(funnel_labels|length) %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>{{ funnel_labels[i] }}</span>
                  <span class="badge 
                    {% if funnel_labels[i] == 'New Lead' %}bg-blue
                    {% elif funnel_labels[i] == 'Issue in Lead' %}bg-red
                    {% elif funnel_labels[i] == 'Pending Outreach' %}bg-orange
                    {% elif funnel_labels[i] == 'Texted / Call Done' %}bg-yellow
                    {% elif funnel_labels[i] == 'In Progress' %}bg-purple
                    {% elif funnel_labels[i] == 'Done' %}bg-green
                    {% else %}bg-secondary{% endif %}">
                    {{ funnel_counts[i] }}
                  </span>
                </div>
                <div class="progress progress-sm mt-2">
                  <div class="progress-bar" style="width: {{ (funnel_counts[i] / (st_total or 1)) * 100 }}%"></div>
                </div>
                <small class="text-muted">{{ "%.1f"|format((funnel_counts[i] / (st_total or 1)) * 100) }}%</small>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Heatmap -->
      <div class="tab-pane" id="heatmap">
        <h3 class="card-title">Lead Volume Heatmap (Weekday Ã— Hour)</h3>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle text-center">
            <thead>
              <tr>
                <th>Day \ Hour</th>
                {% for h in hour_labels %}
                  <th class="text-nowrap">{{ h }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for d_idx in range(weekday_labels|length) %}
                <tr>
                  <th class="text-nowrap">{{ weekday_labels[d_idx] }}</th>
                  {% for h_idx in range(hour_labels|length) %}
                    <td>{{ heatmap[d_idx][h_idx] }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="text-muted small mb-0">Busiest cells â†’ best outreach coverage windows.</p>
      </div>

      <!-- Data Quality -->
      <div class="tab-pane" id="quality">
        <h3 class="card-title">Potential Duplicates (by Customer Number)</h3>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Number</th><th class="text-end">Count</th></tr></thead>
            <tbody>
              {% if dupe_rows %}
                {% for num, c in dupe_rows %}
                  <tr><td class="text-nowrap">{{ num }}</td><td class="text-end">{{ c }}</td></tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="2" class="text-muted">No duplicates in the selected window.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Users Ã— Departments -->
      <div class="tab-pane" id="pivot">
        <h3 class="card-title">Users Ã— Departments (In Range)</h3>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle text-center">
            <thead>
              <tr>
                <th>User \ Dept</th>
                {% for d in departments %}
                  <th>{{ d }}</th>
                {% endfor %}
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% if user_dept %}
                {% for user, deps in user_dept.items() %}
                  {% set row_total = 0 %}
                  <tr>
                    <th class="text-nowrap">{{ user }}</th>
                    {% for d in departments %}
                      {% set val = deps.get(d, 0) %}
                      {% set row_total = row_total + val %}
                      <td>{{ val }}</td>
                    {% endfor %}
                    <th>{{ row_total }}</th>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="{{ departments|length + 2 }}" class="text-muted">No data for selected filters.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Time Series
  new Chart(document.getElementById('tsChart'), {
    type: 'line',
    data: {
      labels: {{ ts_labels|tojson if ts_labels else [] }},
      datasets: [{
        label: 'Leads',
        data: {{ ts_values|tojson if ts_values else [] }},
        borderColor: '#206bc4',
        backgroundColor: 'rgba(32,107,196,0.12)',
        tension: 0.35,
        fill: true
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  // Department
  new Chart(document.getElementById('deptChart'), {
    type: 'doughnut',
    data: {
      labels: {{ dept_labels|tojson if dept_labels else [] }},
      datasets: [{
        data: {{ dept_counts|tojson if dept_counts else [] }},
        backgroundColor: ['#206bc4','#4299e1','#667eea','#f093fb','#e53e3e','#f59e0b','#10b981']
      }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // Users
  new Chart(document.getElementById('userChart'), {
    type: 'bar',
    data: {
      labels: {{ user_labels|tojson if user_labels else [] }},
      datasets: [{
        label: 'Leads',
        data: {{ user_counts|tojson if user_counts else [] }},
        backgroundColor: 'rgba(16,185,129,0.8)',
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { x: { ticks: { autoSkip: false } } }
    }
  });

  // Funnel / Status
  new Chart(document.getElementById('funnelChart'), {
    type: 'bar',
    data: {
      labels: {{ funnel_labels|tojson if funnel_labels else [] }},
      datasets: [{
        label: 'Leads',
        data: {{ funnel_counts|tojson if funnel_counts else [] }},
        backgroundColor: 'rgba(251,191,36,0.85)',
        borderRadius: 6
      }]
    },
    options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
  });
});
</script>

<style>
.bg-blue { background-color: #206bc4 !important; color: #fff; }
.bg-red { background-color: #e53e3e !important; color: #fff; }
.bg-orange { background-color: #f59f00 !important; color: #fff; }
.bg-yellow { background-color: #fbbf24 !important; color: #000; }
.bg-purple { background-color: #8b5cf6 !important; color: #fff; }
.bg-green { background-color: #10b981 !important; color: #fff; }
</style>
{% endblock %}
{% endblock %}
