{% extends "base.html" %}
{% block title %}My Leads – AccBoost CRM{% endblock %}

{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">My Leads</h2>
      <div class="text-muted mt-1">
        {% if triage_mode %}
          Triage queue: newly added leads
        {% else %}
          Leads added by you
        {% endif %}
      </div>
    </div>
    {% if can_add %}
      <div class="col-auto ms-auto">
        <a href="{{ url_for('add_lead') }}" class="btn btn-primary">
          <i class="ti ti-plus me-1"></i> Add New Lead
        </a>
      </div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title fw-semibold">
      {% if triage_mode %}
        New Leads
      {% else %}
        All My Leads
      {% endif %}
    </h3>
    <span class="badge bg-blue-lt text-blue fw-semibold">
      Showing {{ leads|length }}
    </span>
  </div>

  <div class="card-body border-top">

    {% if current_user.role == 'admin' and leads %}
    <form method="POST" action="{{ url_for('bulk_update_status') }}" id="bulkForm">
      <div class="d-flex justify-content-start align-items-center gap-2 mb-3">
        <select name="new_status" class="form-select w-auto" required>
          <option value="">-- Change Status To --</option>
          <option value="New Lead">New Lead</option>
          <option value="Issue in Lead">Issue in Lead</option>
          <option value="Updated">Updated</option>
          <option value="Done">Done (Move to All Leads)</option>
        </select>
        <button class="btn btn-primary" type="submit">Apply to Selected</button>
      </div>
    {% endif %}

    {% if leads %}
      <div class="table-responsive">
        <table class="table table-vcenter table-hover align-middle">
          <thead class="table-light">
            <tr>
              {% if current_user.role == 'admin' %}
              <th><input type="checkbox" id="select_all"></th>
              {% endif %}
              <th>ID</th>
              <th>Client</th>
              <th>Contact</th>
              <th>Department</th>
              <th>Added By</th>
              <th>Date</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for lead in leads %}
              <tr>
                {% if current_user.role == 'admin' %}
                <td><input type="checkbox" name="lead_ids" value="{{ lead.id }}"></td>
                {% endif %}
                
                <td><span class="text-muted">#{{ lead.id }}</span></td>
                <td class="fw-semibold">{{ lead.customer_name }}</td>
                <td>{{ lead.customer_number }}</td>
                <td>
                  <span class="badge bg-blue-lt text-blue">{{ lead.department }}</span>
                </td>
                <td>
                  {% if current_user.role == 'processor' %}
                    —
                  {% else %}
                     {{ lead.added_by }}
                  {% endif %}
                </td>     
                <td class="text-muted small">
                  {{ lead.created_at.strftime('%b %d, %Y') if lead.created_at else 'N/A' }}
                </td>

                <!-- STATUS -->
                <td>
                  {% set color_map = {
                    'New Lead': 'status-blue',
                    'Issue in Lead': 'status-red',
                    'Updated': 'status-yellow',
                    'Done': 'status-gray'
                  } %}

                  {% if current_user.role in ['admin','processor'] and lead.status != 'Done' %}
                    <form method="POST"
                          action="{{ url_for('update_status', lead_id=lead.id) }}"
                          class="m-0">
                      <input type="hidden" name="origin" value="my_leads">
                      <select name="status"
                              class="status-dropdown {{ color_map.get(lead.status, '') }}"
                              onchange="this.form.submit()">
                        <option value="New Lead" {% if lead.status == 'New Lead' %}selected{% endif %}>New Lead</option>
                        <option value="Issue in Lead" {% if lead.status == 'Issue in Lead' %}selected{% endif %}>Issue in Lead</option>
                        <option value="Updated" {% if lead.status == 'Updated' %}selected{% endif %}>Updated</option>
                        <option value="Done">Done (Move to All Leads)</option>
                      </select>
                    </form>
                  {% else %}
                    <span class="status-dropdown {{ color_map.get(lead.status, 'status-gray') }}">
                      {{ lead.status }}
                    </span>
                  {% endif %}
                </td>

                <!-- ACTIONS -->
                <td class="text-end">
                  <div class="btn-list flex-nowrap">
                    <a href="#" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewLead{{ lead.id }}">
                      <i class="ti ti-eye"></i> View
                    </a>
                    {% if current_user.role == 'admin' or current_user.username == lead.added_by %}
                      <a href="{{ url_for('edit_lead', lead_id=lead.id) }}" class="btn btn-sm btn-outline-warning">
                        <i class="ti ti-edit"></i> Edit
                      </a>
                    {% endif %}
                  </div>
                </td>
              </tr>

              <!-- MODAL (unchanged) -->
              <div class="modal modal-blur fade" id="viewLead{{ lead.id }}" tabindex="-1" aria-hidden="true">
                ... (your modal stays unchanged) ...
              </div>

            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if current_user.role == 'admin' %}
      </form>
      {% endif %}

    {% else %}
      <div class="empty my-5 text-center">
        <div class="empty-icon mb-3"><i class="ti ti-inbox fs-1 text-muted"></i></div>
        <p class="empty-title">No leads yet</p>
        <p class="empty-subtitle text-muted">
          {% if triage_mode %} Nothing to triage right now. {% else %} You haven’t added any leads yet. {% endif %}
        </p>
      </div>
    {% endif %}
  </div>
</div>

<script>
document.getElementById("select_all")?.addEventListener("click", function() {
  document.querySelectorAll('input[name="lead_ids"]').forEach(cb => cb.checked = this.checked);
});
</script>

{% endblock %}
