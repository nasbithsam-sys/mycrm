{% extends "base.html" %}

{% block title %}All Leads - AccBoost CRM{% endblock %}

{% block content %}
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h1 class="page-title">All Leads</h1>
      <div class="text-muted mt-1">
        Manage all active leads 
        {% if current_user.role == 'admin' %}(Admin Access){% elif current_user.role == 'processor' %}(Processor Access){% endif %}
      </div>
    </div>
    <div class="col-auto">
      <div class="btn-list">
        <!-- âœ… Export Dropdown â€” Admin Only -->
        {% if current_user.role == 'admin' %}
        <div class="dropdown">
          <button class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="16" height="16"
                 viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                 stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
              <path d="M7 11l5 5l5 -5" />
              <path d="M12 4l0 12" />
            </svg>
            Export Report
          </button>
          <div class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" href="{{ url_for('export_closed_leads', type='csv') }}">Export as CSV</a>
            <a class="dropdown-item" href="{{ url_for('export_closed_leads', type='xlsx') }}">Export as Excel</a>
            <a class="dropdown-item" href="{{ url_for('export_closed_leads', type='pdf') }}">Export as PDF</a>
          </div>
        </div>
        {% endif %}

        <!-- âž• Add New Lead -->
        <a href="{{ url_for('add_lead') }}" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plus" width="16" height="16"
               viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
               stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path d="M12 5l0 14" />
            <path d="M5 12l14 0" />
          </svg>
          Add New Lead
        </a>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”½ Filters Section -->
<div class="card mb-4">
  <div class="card-header">
    <h3 class="card-title">Filters</h3>
  </div>
  <div class="card-body">
    <form method="GET" action="{{ url_for('view_leads') }}" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Status</label>
        <select name="status" class="form-select" onchange="this.form.submit()">
          <option value="all" {% if request.args.get('status', 'all') == 'all' %}selected{% endif %}>All Statuses</option>
          <option value="Pending Outreach" {% if request.args.get('status') == 'Pending Outreach' %}selected{% endif %}>Pending Outreach</option>
          <option value="Texted / Call Done" {% if request.args.get('status') == 'Texted / Call Done' %}selected{% endif %}>Texted / Call Done</option>
          <option value="In Progress" {% if request.args.get('status') == 'In Progress' %}selected{% endif %}>In Progress</option>
          <option value="Done" {% if request.args.get('status') == 'Done' %}selected{% endif %}>Done (Move to Closed Leads)</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Department</label>
        <select name="department" class="form-select" onchange="this.form.submit()">
          <option value="all" {% if request.args.get('department', 'all') == 'all' %}selected{% endif %}>All Departments</option>
          {% for dept in departments %}
          <option value="{{ dept }}" {% if request.args.get('department') == dept %}selected{% endif %}>{{ dept }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">&nbsp;</label>
        <div>
          <a href="{{ url_for('view_leads') }}" class="btn btn-outline-secondary">Clear Filters</a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ðŸ“‹ Leads Table -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">All Active Leads</h3>
    <div class="card-actions">
      <div class="text-muted">
        Showing {{ leads|length }} lead{% if leads|length != 1 %}s{% endif %}
      </div>
    </div>
  </div>
  
  <div class="card-body">
    {% if leads %}
    <div class="table-responsive">
      <table class="table table-vcenter table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Contact</th>
            <th>Department</th>
            <th>Added By</th>
            <th>Date</th>
            <th>Status</th>
            <th>Attachment</th>
            <th class="w-1">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for lead in leads %}
          <tr>
            <td><span class="text-muted">#{{ lead.id }}</span></td>
            <td><div class="font-weight-medium">{{ lead.customer_name }}</div></td>
            <td>{{ lead.customer_number }}</td>
            <td><span class="badge bg-primary-lt">{{ lead.department }}</span></td>
            <td>{{ lead.added_by }}</td>
            <td>{{ lead.created_at.strftime('%b %d, %Y') if lead.created_at else 'N/A' }}</td>
            
            <td>
              <!-- Admin or Processor Status Update -->
              {% if current_user.role in ['admin', 'processor'] %}
              <form method="POST" action="{{ url_for('update_status', lead_id=lead.id) }}">
                <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                  <option value="Pending Outreach" {% if lead.status == "Pending Outreach" %}selected{% endif %}>Pending Outreach</option>
                  <option value="Texted / Call Done" {% if lead.status == "Texted / Call Done" %}selected{% endif %}>Texted / Call Done</option>
                  <option value="In Progress" {% if lead.status == "In Progress" %}selected{% endif %}>In Progress</option>
                  <option value="Done" {% if lead.status == "Done" %}selected{% endif %}>Done (Move to Closed Leads)</option>
                </select>
                <input type="hidden" name="origin" value="all_leads">
              </form>
              {% else %}
              <span class="badge bg-secondary-lt">{{ lead.status }}</span>
              {% endif %}
            </td>

            <td>
              {% if lead.attachment_filename %}
                <a href="{{ url_for('uploaded_file', filename=lead.attachment_filename) }}" target="_blank">View</a>
              {% else %}
                <span class="text-muted">No file</span>
              {% endif %}
            </td>

            <td>
              <a href="#" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewLead{{ lead.id }}">View</a>
              {% if current_user.role == 'admin' %}
              <form action="{{ url_for('delete_lead', lead_id=lead.id) }}" method="POST" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete lead #{{ lead.id }}?');">Delete</button>
              </form>
              {% endif %}
            </td>
          </tr>

          <!-- ðŸ“„ Lead Details Modal -->
          <div class="modal fade" id="viewLead{{ lead.id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Lead Details: {{ lead.customer_name }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p><strong>Contact:</strong> {{ lead.customer_number }}</p>
                  <p><strong>Department:</strong> {{ lead.department }}</p>
                  <p><strong>Service:</strong> {{ lead.context_service or 'N/A' }}</p>
                  <p><strong>Status:</strong> {{ lead.status }}</p>
                  <p><strong>Added By:</strong> {{ lead.added_by }}</p>
                  <p><strong>Date:</strong> {{ lead.created_at.strftime('%b %d, %Y %H:%M') if lead.created_at else 'N/A' }}</p>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty text-center">
      <p class="empty-title">No leads found</p>
      <p class="empty-subtitle text-muted">No active leads available.</p>
    </div>
    {% endif %}
  </div>
</div>

{% endblock %}
