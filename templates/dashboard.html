{% extends "base.html" %}

{% block title %}Dashboard - AccBoost CRM{% endblock %}

{% block content %}
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h1 class="page-title">Dashboard</h1>
      <div class="text-muted mt-1">
        Last updated:
        <span id="update-time">{{ now.strftime('%H:%M') if now else 'Just now' }}</span>
      </div>
    </div>
    <div class="col-auto">
      <div class="btn-list">
        <a href="{{ url_for('add_lead') }}" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M12 5l0 14" />
            <path d="M5 12l14 0" />
          </svg>
          Add New Lead
        </a>
      </div>
    </div>
  </div>
</div>

{% if is_admin %}
<!-- ============================ -->
<!-- ðŸ”¹ ADMIN DASHBOARD -->
<!-- ============================ -->
{{ super() }}
{% elif is_processor %}
<!-- ============================ -->
<!-- ðŸŸ¢ PROCESSOR DASHBOARD -->
<!-- ============================ -->
<div class="row row-deck mb-4">
  <div class="col-sm-6 col-lg-4">
    <div class="card card-sm kpi-card">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-success text-white avatar">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" />
                <path d="M6 21v-2a4 4 0 0 1 4 -4h4" />
                <path d="M15 19l2 2l4 -4" />
              </svg>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">MY LEADS</div>
            <div class="h2 mt-2 mb-0 text-success">{{ my_leads }}</div>
            <div class="text-muted">Assigned to you</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-sm-6 col-lg-4">
    <div class="card card-sm kpi-card">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-auto">
            <span class="bg-warning text-white avatar">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                <path d="M9 12l6 0" />
                <path d="M12 9l0 6" />
              </svg>
            </span>
          </div>
          <div class="col">
            <div class="font-weight-medium">NEW LEADS TODAY</div>
            <div class="h2 mt-2 mb-0 text-warning">{{ new_today }}</div>
            <div class="text-muted">Created today</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Processor Access -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Quick Access</h3>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <a href="{{ url_for('leads') }}" class="card card-sm bg-success text-white action-tile">
              <div class="card-body text-center p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M9 6l11 0" />
                  <path d="M9 12l11 0" />
                  <path d="M9 18l11 0" />
                  <path d="M5 6l0 .01" />
                  <path d="M5 12l0 .01" />
                  <path d="M5 18l0 .01" />
                </svg>
                <div class="font-weight-medium">My Leads</div>
              </div>
            </a>
          </div>
          <div class="col-md-4">
            <a href="{{ url_for('view_leads') }}" class="card card-sm bg-primary text-white action-tile">
              <div class="card-body text-center p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
                  <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" />
                </svg>
                <div class="font-weight-medium">All Leads</div>
              </div>
            </a>
          </div>
          <div class="col-md-4">
            <a href="{{ url_for('add_lead') }}" class="card card-sm bg-info text-white action-tile">
              <div class="card-body text-center p-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                  <path d="M12 5l0 14" />
                  <path d="M5 12l14 0" />
                </svg>
                <div class="font-weight-medium">Add Lead</div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% else %}
<!-- ============================ -->
<!-- ðŸ”µ USER DASHBOARD -->
<!-- ============================ -->
{{ super() }}
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Chart.js for admin only -->
{% if is_admin %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if dept_labels and dept_counts %}
    const ctx = document.getElementById('deptChart');
    if (ctx) {
        new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: {{ dept_labels|default([])|tojson }},
                datasets: [{
                    data: {{ dept_counts|default([])|tojson }},
                    backgroundColor: ['#206bc4','#2fb344','#f59f00','#4299e1','#e64980','#868e96','#5c7cfa','#20c997'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { usePointStyle: true, padding: 20, font: { size: 11 } } 
                    }
                },
                cutout: '65%'
            }
        });
    }
    {% endif %}
});
</script>
{% endif %}
{% endblock %}
