{% extends "base.html" %}
{% block title %}All Leads - AccBoost CRM{% endblock %}

{% block content %}
<div class="page-header">
  <div class="row align-items-center">
    <div class="col">
      <h1 class="page-title">All Leads</h1>
      <div class="text-muted mt-1">
        Manage all active leads
        {% if current_user.role == 'admin' %}
        {% elif current_user.role == 'processor' %}
        {% endif %}
      </div>
    </div>

    <div class="col-auto">
      <div class="btn-list">
        <!-- ✅ Export only for Admin -->
        {% if current_user.role == 'admin' %}
        <div class="dropdown">
          <button class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24"
                 stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
              <path d="M7 11l5 5l5 -5" />
              <path d="M12 4v12" />
            </svg>
            Export
          </button>
          <div class="dropdown-menu dropdown-menu-end">
            <a class="dropdown-item" href="{{ url_for('export_closed_leads', type='csv') }}">CSV</a>
            <a class="dropdown-item" href="{{ url_for('export_closed_leads', type='xlsx') }}">Excel</a>
            <a class="dropdown-item" href="{{ url_for('export_closed_leads', type='pdf') }}">PDF</a>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- 🔽 Filters -->
<div class="card mb-4">
  <div class="card-header"><h3 class="card-title">Filters</h3></div>
  <div class="card-body">
    <form method="GET" action="{{ url_for('view_leads') }}" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Status</label>
        <select name="status" class="form-select" onchange="this.form.submit()">
          <option value="all" {% if request.args.get('status', 'all') == 'all' %}selected{% endif %}>All</option>
          {% for s in statuses if not (current_user.role == 'processor' and s in ['Archived', 'Deleted']) %}
          <option value="{{ s }}" {% if request.args.get('status') == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Department</label>
        <select name="department" class="form-select" onchange="this.form.submit()">
          <option value="all" {% if request.args.get('department', 'all') == 'all' %}selected{% endif %}>All</option>
          {% for dept in departments %}
          <option value="{{ dept }}" {% if request.args.get('department') == dept %}selected{% endif %}>{{ dept }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">&nbsp;</label>
        <div>
          <a href="{{ url_for('view_leads') }}" class="btn btn-outline-secondary">Clear Filters</a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- 📋 Leads Table -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">All Leads</h3>
    <div class="card-actions">
      <div class="text-muted">Showing {{ leads|length }} lead{% if leads|length != 1 %}s{% endif %}</div>
    </div>
  </div>

  <div class="card-body">
    {% if leads %}
    <div class="table-responsive">
      <table class="table table-vcenter table-hover align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Contact</th>
            <th>Department</th>
            <th>Added By</th>
            <th>Date</th>
            <th>Status</th>
            <th>Attachment</th>
            <th class="w-1">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for lead in leads %}
          <tr>
            <td>#{{ lead.id }}</td>
            <td><strong>{{ lead.customer_name }}</strong></td>
            <td>{{ lead.customer_number }}</td>
            <td><span class="badge bg-primary-lt">{{ lead.department }}</span></td>
            <td>{{ lead.added_by }}</td>
            <td class="text-muted small">{{ lead.created_at.strftime('%b %d, %Y') if lead.created_at else 'N/A' }}</td>

            <!-- ✅ Editable Status for Admin & Processor -->
            <td>
              {% if current_user.role in ['admin', 'processor'] %}
              <form method="POST" action="{{ url_for('update_status', lead_id=lead.id) }}">
                <input type="hidden" name="origin" value="all_leads">
                <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                  {% for s in statuses_pipeline %}
                    <option value="{{ s }}" {% if lead.status == s %}selected{% endif %}>{{ s }}</option>
                  {% endfor %}
                </select>
              </form>
              {% else %}
              <span class="badge bg-secondary-lt">{{ lead.status }}</span>
              {% endif %}
            </td>

            <!-- 📎 Attachment -->
            <td>
              {% if lead.attachment_filename %}
                <a href="{{ lead.attachment_filename }}" target="_blank" class="text-primary">View</a>
              {% else %}
                <span class="text-muted">No file</span>
              {% endif %}
            </td>

            <!-- ⚙️ Actions -->
            <td>
              <div class="btn-group">
                <a href="#" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewLead{{ lead.id }}">View</a>
                {% if current_user.role == 'admin' %}
                <form action="{{ url_for('delete_lead', lead_id=lead.id) }}" method="POST" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete lead #{{ lead.id }}?');">Delete</button>
                </form>
                {% endif %}
              </div>
            </td>
          </tr>

          <!-- 📄 Lead Details Modal -->
          <div class="modal fade" id="viewLead{{ lead.id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Lead Details: {{ lead.customer_name }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p><strong>Contact:</strong> {{ lead.customer_number }}</p>
                  <p><strong>Department:</strong> {{ lead.department }}</p>
                  <p><strong>Service:</strong> {{ lead.context_service or 'N/A' }}</p>
                  <p><strong>Status:</strong> {{ lead.status }}</p>
                  <p><strong>Added By:</strong> {{ lead.added_by }}</p>
                  <p><strong>Date:</strong> {{ lead.created_at.strftime('%b %d, %Y %H:%M') if lead.created_at else 'N/A' }}</p>
                  {% if lead.attachment_filename %}
                    <p><strong>Attachment:</strong> <a href="{{ lead.attachment_filename }}" target="_blank">Open File</a></p>
                  {% endif %}
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty text-center py-5">
      <p class="empty-title">No leads found</p>
      <p class="empty-subtitle text-muted">No leads available at this time.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
